Instructions for RTEMS EVR users                    Last Updated 01/29/2007
--------------------------------

I - Adding the event package to your IOC application:
-----------------------------------------------------

(1) Add EVENT and GENERALTIME to configure/RELEASE and clean/rebuild configure:

EVENT=/afs/slac/g/lcls/epics/site/src/event
GENERALTIME=/afs/slac/g/lcls/epics/site/src/event
 OR (if using /afs/slac/g/lcls/epics/ioc/configure):
include $(TOP)/../site/configure/RELEASE-event
include $(TOP)/../site/configure/RELEASE-generalTime

(2) Link event libraries into your app by adding to xxxApp/src/Makefile:

   xxx_LIBS += evrSupport
   xxx_LIBS += drvSupport
   xxx_LIBS += sSubRecord
   xxx_LIBS += generalTime
   xxx_LIBS += devMrfEr
   xxx_LIBS += mrfVme64x
 OR (if using /afs/slac/g/lcls/epics/ioc/configure):
   xxx_LIBS += $(EVR_IOC_LIBS)
   xxx_LIBS += $(EVR_RTEMS_IOC_LIBS)

Note that the order of the above libraries is important.

(3) Add the following .dbd files to xxxApp/src/Makefile 
    or to xxxApp/src/xxxInclude.dbd:

   xxx_DBD += evrSupport.dbd
   xxx_DBD += devMrfEr.dbd

(4) Install the following general database files from the event package to 
    your application by adding to xxxApp/Db/Makefile:

   DB_INSTALLS += $(EVENT)/db/evrPattern.db
   DB_INSTALLS += $(EVENT)/db/evrPatternProc.db
   DB_INSTALLS += $(EVENT)/db/evrFiducial.db
   DB_INSTALLS += $(EVENT)/db/evrPattern.template
   DB_INSTALLS += $(EVENT)/db/evrPatternProc.template
   DB_INSTALLS += $(EVENT)/db/bsaEdefAvg.db
   DB_INSTALLS += $(EVENT)/db/bsaEdefFanouts.db
   DB_INSTALLS += $(EVENT)/db/bsaEdefShadow.db
   DB_INSTALLS += $(EVENT)/db/bsaShadow.template
 OR (if using /afs/slac/g/lcls/epics/ioc/configure):
   DB_INSTALLS += $(EVR_IOC_DBS)
   DB_INSTALLS += $(BSA_IOC_DBS)
   
(5) Install the following application-specific and ioc-specific database 
    files from the event package to your application by adding to 
    xxxApp/Db/Makefile:

   DB_INSTALLS += $(EVENT)/db/bsaBPMSEdef.template (if applicable)
   DB_INSTALLS += $(EVENT)/db/bsaTOROEdef.template (if applicable)
   DB_INSTALLS += $(EVENT)/db/bsaBLENEdef.template (if applicable)
   DB_INSTALLS += $(EVENT)/db/bsaPMTEdef.template  (if applicable)
   DB_INSTALLS += $(EVENT)/db/IOC-<area>-<xxyy>evr.db
   DB_INSTALLS += $(EVENT)/db/IOC-<area>-<xxyy>pattern.template
   DB_INSTALLS += $(GENERALTIME)/db/generalTimeNonVx.template

   where area = LR20, IN20, LI21, etc
   and   xx = subsystem ID (AM, BL, BP, IM, LS, MG, MP, PM, RF, WS)
         yy = unique number per area and subSystem ID (01, 02, 03, etc)

II - Adding event database and EVR configuration to your IOC startup file:
--------------------------------------------------------------------------

(1) Add database templates to st.cmd (before iocInit): 

    dbLoadTemplate("db/IOC-<area>-<xxyy>evr.template")
    dbLoadTemplate("db/IOC-<area>-<xxyy>pattern.template")

(2) Add ErConfigure for each VME EVR (before iocInit):

    ErConfigure(<z>,0x300000,0x60,4,0)

    where z        = physical slot number in the VME crate, starting from 1
    and   0x300000 = card address for card 1
    and   0x60     = interrupt vector
    and   4        = interrupt level
    and   0        = VME

(3) Add ErConfigure for each PMC EVR (before iocInit):

    ErConfigure(<z>,0,0,0,1)
    where z = 0 for PMC Slot 1 (lower slot), 1 for PMC slot 2 (upper slot)
    and   0 = card address     (not used)
    and   0 = interrupt vector (not used)
    and   0 = interrupt level  (not used)
    and   1 = PMC

III - Hardware Setup:
---------------------

(1) Installation instructions for the PMC EVR are here:
    http://www.slac.stanford.edu/grp/lcls/controls/global/subsystems/timing/PMC-EVR_install_inst_v1d0.pdf

(2) Connect fiber from a nearby timing fiber fanout module to each EVR.  These 
    fanout modules are identified in the timing system block diagram by 
    Mike Browne:
    https://sharepoint.slac.stanford.edu/sites/LCLS%20Document%20Storage/
    01%20-%20LCLS%20Systems/electronbeamsys/controls/Shared%20Documents/
    Timing/TIMING%20System%20BD.pdf

