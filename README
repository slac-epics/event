Instructions for RTEMS EVR users                    Last Updated 02/06/2007
--------------------------------

I - Adding the event package to your IOC application:
-----------------------------------------------------

(1) Add EVENT, GENERALTIME, and SSUBRECORD to configure/RELEASE and 
clean/rebuild configure:

EVENT=/afs/slac/g/lcls/epics/site/src/event
GENERALTIME=/afs/slac/g/lcls/epics/site/src/generalTime
SSUBRECORD=/afs/slac/g/lcls/epics/site
 OR 
include $(TOP)/../site/configure/RELEASE-event
include $(TOP)/../site/configure/RELEASE-generalTime
SSUBRECORD=$(TOP)/../site

(2) Link event libraries into your app by adding to xxxApp/src/Makefile:

   xxx_LIBS += evrSupport
   xxx_LIBS += drvSupport
   xxx_LIBS += sSubRecord
   xxx_LIBS += generalTime
   xxx_LIBS += devMrfEr
   xxx_LIBS += mrfVme64x
 OR (if including /afs/slac/g/lcls/epics/site/configure/RELEASE-event in
     your xxxApp/configure/RELEASE):
   xxx_LIBS += $(EVR_IOC_LIBS)
   xxx_LIBS += $(EVR_RTEMS_IOC_LIBS)

Note that the order of the above libraries is important.

(3) Add the following .dbd files to xxxApp/src/Makefile 
    or to xxxApp/src/xxxInclude.dbd:

   xxx_DBD += evrSupport.dbd
   xxx_DBD += devMrfEr.dbd

(4) Install the following applicable ioc-specific database 
    files from the event package to your application by adding to 
    xxxApp/Db/Makefile:

   DB_INSTALLS += $(EVENT)/db/IOC-<area>-<xxyy>evr.db
   DB_INSTALLS += $(EVENT)/db/IOC-<area>-<xxyy>pattern.db
   And for IOCs that support beam-synchronous acquisition:
   DB_INSTALLS += $(EVENT)/db/IOC-<area>-<xxyy>bsa.db

   where area = LR20, IN20, LI21, etc
   and   xx = subsystem ID (AM, BL, BP, IM, LS, MG, MP, PM, RF, WS)
         yy = unique number per area and subSystem ID (01, 02, 03, etc)

II - Adding event databases and EVR configuration to your IOC startup file:
--------------------------------------------------------------------------

(1) If you have one or more VME EVRs and your IOC is using an early version 
    of RTEMS (ie, version "4.7" instead of "4.7.0"), then add these 
    instructions early in the startup file, before any EPICS commands:

    # Carve a slice out of A32 space for the CR/CSR
    # First, make the A32 space smaller...
    BSP_VMEOutboundPortCfg(0,0xd,0x20000000,0x9<<28,0x0e000000)
    # Then, make the CSR space in the freed up space (from 0x9e000000 to 0x9f000000)
    BSP_VMEOutboundPortCfg(3,0x2f,0,0x9e000000,0x01000000)

(2) Add database templates to st.cmd (before iocInit): 

   dbLoadRecords("db/IOC-<area>-<xxyy>evr.db")
   dbLoadRecords("db/IOC-<area>-<xxyy>pattern.db")
   And for IOCs that support beam-synchronous acquisition:
   dbLoadRecords("db/IOC-<area>-<xxyy>bsa.db")

(3) Add ErConfigure for each VME EVR (before iocInit).  For the first VME card:

    ErConfigure(<z>,0x300000,0x60,4,0)

    where z        = physical slot number in the VME crate, counting from 1
    and   0x300000 = card address for card 1, 
                     increment by 0x100000 for each subsequent card
    and   0x60     = interrupt vector for card 1, 
                     increment by  0x02 for each subsequent card
    and   4        = interrupt level (can be the same for all VME EVRs)
    and   0        = VME

(4) Add ErConfigure for each PMC EVR (before iocInit):

    ErConfigure(<z>,0,0,0,1)
    where z = 0 for first PMC instance, 1 for second PMC instance
    and   0 = card address     (not used)
    and   0 = interrupt vector (not used)
    and   0 = interrupt level  (not used)
    and   1 = PMC

III - Hardware Setup:
---------------------

(1) Installation instructions for the PMC EVR are here:
    http://www.slac.stanford.edu/grp/lcls/controls/global/subsystems/timing/PMC-EVR_install_inst_v1d0.pdf

(2) Connect fiber from a nearby timing fiber fanout module to each EVR.  These 
    fanout modules are identified in the timing system block diagram by 
    Mike Browne:
    https://sharepoint.slac.stanford.edu/sites/LCLS%20Document%20Storage/
    01%20-%20LCLS%20Systems/electronbeamsys/controls/Shared%20Documents/
    Timing/TIMING%20System%20BD.pdf

